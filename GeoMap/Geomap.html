<html>
    <head>
        <meta charset="utf-8">
        <link rel="shortcut icon" type="image/png" href="favicon.ico"/>
        <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet"> 
        <title>Avarage temperatures</title>
        <script src="Assets/geomap/vendor/d3.geomap.dependencies.min.js"></script>
        <script src="Assets/topojson.min.js"></script>
        <script src="Assets/datamaps.world.hires.min.js"></script>
    </head>
    <body>
       
            <div style="font-family: 'Lato', sans-serif;">Heat through the years</div>
        </div>
        <div id="map" style="position: relative; width: 1000; height: 750; left:calc(50% - 500px); position:relative;"></div>
        <script type="text/javascript">
            var tempByCountry;
            var paletteScale;
            var dataset = {};

            var map = new Datamap({element: document.getElementById('map'),
                geographyConfig: {
                    popupTemplate: function(geography, data) {
                        return '<div class="hoverinfo"><b>' + geography.properties.name + '</b></br>' + 'Temperature:' +  data.amount + '</div>'
                    }
                },
                fills: {
                    defaultFill: '#efe5de' 
                },
                projection: 'mercator'
            });

            d3.csv("Jan2013.csv", function(data) {
                tempByCountry = data;
            });

            
            d3.csv("country-codes.csv", function(data) {
                countryCodes = data;
            });

            var loadInterval = setInterval(setCountryCodes, 1000);

            function setCountryCodes(){
                console.log('Loading...');
                console.log(tempByCountry);
            

                if (tempByCountry !== undefined && countryCodes !== undefined){
                    for(country in tempByCountry){
                        
                        var oldCountryCode = tempByCountry[country]['Country'];
                        
                        var newCountryCode = '';
                       
                        for(code in countryCodes){
                            
                            if (countryCodes[code]['official_name_en'] == oldCountryCode){
                                newCountryCode = countryCodes[country]['ISO3166-1-Alpha-3'];
                                
                            }
                        }
                        tempByCountry[country]['Country3'] = newCountryCode;
                      
                    }
                    console.log('Done!');
                   
                    clearInterval(loadInterval);
                    setColours(-20,35); 
                }
            }
            function setColours(min, max){
                var paletteScale = d3.scale.log()
                    .domain([min,max])
                    .range(["#005271","#710900"]); // blue color
                updateMap(paletteScale);
            }

           
            function updateMap(palette){
                for(country in tempByCountry){
                    var iso = tempByCountry[country]['Country3'],
                        value = Number(tempByCountry[country].AverageTemperature);
                    dataset[iso] = { amount: value, fillColor: palette(value) };
                    
                }
                console.log(dataset);
                map.updateChoropleth(dataset);
            }

            
            
        </script>
    </body>
</html>
